<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Tours VR Hub ¬∑ ESP32 Control</title>
    <!-- A-Frame for VR -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
        }
        
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            color: white;
            font-family: Arial, sans-serif;
            transition: opacity 0.5s;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #333;
            border-top: 5px solid #FF6B6B;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #vr-scene {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        #instructions {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-family: Arial, sans-serif;
            text-align: center;
            z-index: 100;
            backdrop-filter: blur(5px);
            pointer-events: none; /* so ESP cursor can click through */
        }

        /* ---------- ESP32 VISUAL CUSTOM CURSOR ---------- */
        #esp-cursor {
            position: fixed;
            width: 24px;
            height: 24px;
            background: rgba(255, 70, 70, 0.9);
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(255,100,100,0.8);
            pointer-events: none;      /* absolutely crucial: lets clicks/events pass to A-Frame elements */
            z-index: 99999;
            transform: translate(-50%, -50%);
            display: none;
            transition: width 0.1s, height 0.1s, background 0.1s;
            mix-blend-mode: difference; /* makes it visible on any background */
        }
        /* small inner dot for precision */
        #esp-cursor::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 4px;
            background: white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        /* highlight state when hovering a clickable object */
        #esp-cursor.hovering {
            width: 36px;
            height: 36px;
            background: rgba(255, 215, 0, 0.9); /* gold */
            border-color: #FF6B6B;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="spinner"></div>
        <h2>Loading VR Environment</h2>
        <p>Please wait while we prepare your VR experience...</p>
    </div>

    <!-- Instructions -->
    <div id="instructions" style="display: none;">
        <p>üëÜ ESP32‚ÄëCAM moves cursor ¬∑ gaze/hover to select (dwell‚Äëtime simulated)</p>
        <p>‚å®Ô∏è Press 1‚Äë5 for quick selection ¬∑ F for fullscreen</p>
    </div>

    <!-- VR Scene -->
    <div id="vr-scene">
        <a-scene embedded vr-mode-ui="enabled: true" id="main-scene">
            <!-- Background -->
            <a-sky color="#0a1929"></a-sky>
            
            <!-- Menu Title -->
            <a-text value="VIRTUAL TOURS" 
                   position="0 3.5 -4" 
                   align="center" 
                   color="#FF6B6B" 
                   width="6"
                   scale="2 2 1"></a-text>
            <a-text value="Bulacan Historical Sites" 
                   position="0 2.8 -4" 
                   align="center" 
                   color="#FFFFFF" 
                   width="5"
                   scale="1.2 1.2 1"
                   opacity="0.8"></a-text>
            
            <!-- Menu Options - Arranged in a curved arc for better visibility -->
            <a-entity id="menu-options" position="0 1.6 0">
                <!-- Battle of Quinga (Left) -->
                <a-entity class="menu-option" 
                         position="-2.5 0.5 -2" 
                         data-project="battle-of-quinga"
                         data-color="#FF6B6B">
                    <a-box width="1" height="1" depth="0.1" color="#FF6B6B">
                        <a-animation attribute="rotation" 
                                   to="0 360 0" 
                                   dur="10000" 
                                   repeat="indefinite"></a-animation>
                    </a-box>
                    <a-text value="Battle" 
                           position="0 0.2 0.1" 
                           align="center" 
                           color="white" 
                           width="2"
                           scale="0.8 0.8 1"></a-text>
                    <a-text value="of Quinga" 
                           position="0 -0.2 0.1" 
                           align="center" 
                           color="white" 
                           width="2"
                           scale="0.8 0.8 1"></a-text>
                    <a-text value="1" 
                           position="0 -0.6 0.1" 
                           align="center" 
                           color="white" 
                           width="1"></a-text>
                </a-entity>
                
                <!-- Bulacan Museum (Left-Center) -->
                <a-entity class="menu-option" 
                         position="-1.3 0.5 -2" 
                         data-project="bulacan-museum"
                         data-color="#4ECDC4">
                    <a-box width="1" height="1" depth="0.1" color="#4ECDC4">
                        <a-animation attribute="rotation" 
                                   to="0 360 0" 
                                   dur="10000" 
                                   repeat="indefinite"></a-animation>
                    </a-box>
                    <a-text value="Hiyas ng" 
                           position="0 0.2 0.1" 
                           align="center" 
                           color="white" 
                           width="2"
                           scale="0.8 0.8 1"></a-text>
                    <a-text value="Bulacan" 
                           position="0 -0.2 0.1" 
                           align="center" 
                           color="white" 
                           width="2"
                           scale="0.8 0.8 1"></a-text>
                    <a-text value="2" 
                           position="0 -0.6 0.1" 
                           align="center" 
                           color="white" 
                           width="1"></a-text>
                </a-entity>
                
                <!-- Del Pilar Shrine (Center) -->
                <a-entity class="menu-option" 
                         position="0 0.5 -2" 
                         data-project="del-pilar-shrine"
                         data-color="#FFD700">
                    <a-box width="1" height="1" depth="0.1" color="#FFD700">
                        <a-animation attribute="rotation" 
                                   to="0 360 0" 
                                   dur="10000" 
                                   repeat="indefinite"></a-animation>
                    </a-box>
                    <a-text value="Del Pilar" 
                           position="0 0.2 0.1" 
                           align="center" 
                           color="white" 
                           width="2"
                           scale="0.8 0.8 1"></a-text>
                    <a-text value="Shrine" 
                           position="0 -0.2 0.1" 
                           align="center" 
                           color="white" 
                           width="2"
                           scale="0.8 0.8 1"></a-text>
                    <a-text value="3" 
                           position="0 -0.6 0.1" 
                           align="center" 
                           color="white" 
                           width="1"></a-text>
                </a-entity>
                
                <!-- Barasoain Museum (Right-Center) -->
                <a-entity class="menu-option" 
                         position="1.3 0.5 -2" 
                         data-project="barasoain-museum"
                         data-color="#FF8E53">
                    <a-box width="1" height="1" depth="0.1" color="#FF8E53">
                        <a-animation attribute="rotation" 
                                   to="0 360 0" 
                                   dur="10000" 
                                   repeat="indefinite"></a-animation>
                    </a-box>
                    <a-text value="Barasoain" 
                           position="0 0.2 0.1" 
                           align="center" 
                           color="white" 
                           width="2"
                           scale="0.8 0.8 1"></a-text>
                    <a-text value="Museum" 
                           position="0 -0.2 0.1" 
                           align="center" 
                           color="white" 
                           width="2"
                           scale="0.8 0.8 1"></a-text>
                    <a-text value="4" 
                           position="0 -0.6 0.1" 
                           align="center" 
                           color="white" 
                           width="1"></a-text>
                </a-entity>
                
                <!-- CASA REAL SHRINE (Right) - NEW -->
                <a-entity class="menu-option" 
                         position="2.5 0.5 -2" 
                         data-project="casa-real-shrine"
                         data-color="#9B59B6">
                    <a-box width="1" height="1" depth="0.1" color="#9B59B6">
                        <a-animation attribute="rotation" 
                                   to="0 360 0" 
                                   dur="10000" 
                                   repeat="indefinite"></a-animation>
                    </a-box>
                    <a-text value="Casa Real" 
                           position="0 0.2 0.1" 
                           align="center" 
                           color="white" 
                           width="2"
                           scale="0.8 0.8 1"></a-text>
                    <a-text value="Shrine" 
                           position="0 -0.2 0.1" 
                           align="center" 
                           color="white" 
                           width="2"
                           scale="0.8 0.8 1"></a-text>
                    <a-text value="5" 
                           position="0 -0.6 0.1" 
                           align="center" 
                           color="white" 
                           width="1"></a-text>
                </a-entity>
            </a-entity>
            
            <!-- Floor Grid for reference -->
            <a-grid position="0 0 -4" width="10" height="10" color="#FFFFFF" opacity="0.2"></a-grid>
            
            <!-- Camera and Cursor (original A-Frame cursor remains for VR gaze, but ESP cursor will also trigger) -->
            <a-entity camera look-controls position="0 1.6 0" id="main-camera">
                <a-cursor 
                    fuse="true"
                    fuse-timeout="2000"
                    material="color: #FF6B6B"
                    position="0 0 -1">
                </a-cursor>
            </a-entity>
            
            <!-- Lighting -->
            <a-light type="ambient" color="#fff" intensity="0.6"></a-light>
            <a-light type="point" intensity="1" position="5 5 5" color="#fff"></a-light>
            <a-light type="point" intensity="0.5" position="-5 5 5" color="#4ECDC4"></a-light>
            <a-light type="point" intensity="0.5" position="5 5 -5" color="#9B59B6"></a-light>
        </a-scene>
    </div>

    <!-- ESP32 Cursor element (will be populated by script) -->
    <!-- defined in style, actual div created in script but we already have it in style, let's create programmatically -->
    
    <script>
        // ================= PROJECT CONFIG =================
        const projects = {
            'battle-of-quinga': {
                name: 'Battle of Quinga',
                path: 'battle-of-quinga/index.html',
                color: '#FF6B6B'
            },
            'bulacan-museum': {
                name: 'Hiyas ng Bulacan Museum',
                path: 'hiyas-ng-bulacan-museum/index.html',
                color: '#4ECDC4'
            },
            'del-pilar-shrine': {
                name: 'Marcelo H. Del Pilar Shrine',
                path: 'del-pilar-shrine/index.html',
                color: '#FFD700'
            },
            'barasoain-museum': {
                name: 'Barasoain Museum',
                path: 'barasoain-museum/index.html',
                color: '#FF8E53'
            },
            'casa-real-shrine': {
                name: 'Casa Real Shrine',
                path: 'casa-real-shrine/index.html',
                color: '#9B59B6'
            }
        };

        // ========== ESP32 CAM CONTROLLER CODE ==========
        // 1. SET YOUR ESP32-CAM IP HERE (REPLACE WITH YOUR ACTUAL IP)
        const ESP32_IP = "192.168.1.XX"; // üî¥ CHANGE THIS TO THE IP FROM SERIAL MONITOR
        let socket = null;
        
        // Create visual cursor (we'll append it now)
        const espCursor = document.createElement('div');
        espCursor.id = "esp-cursor";
        // styling already in head, but set any missing
        document.body.appendChild(espCursor);

        // attempt WebSocket connection (if IP is not default placeholder)
        function initESP32Cursor() {
            if (ESP32_IP === "192.168.1.XX") {
                console.warn("‚ö†Ô∏è ESP32 IP not set. Using fallback mouse simulation (for demo).");
                // fallback: use mouse to move cursor for testing (simulate ESP)
                document.addEventListener('mousemove', (e) => {
                    espCursor.style.display = 'block';
                    espCursor.style.left = e.clientX + 'px';
                    espCursor.style.top = e.clientY + 'px';
                });
                return;
            }

            try {
                socket = new WebSocket(`ws://${ESP32_IP}:81`);

                socket.onopen = () => {
                    console.log("‚úÖ Connected to ESP32-CAM Controller");
                    espCursor.style.display = "block";
                };

                socket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        // Map 320x240 ESP32 coordinates to screen resolution
                        const screenX = (data.x / 320) * window.innerWidth;
                        const screenY = (data.y / 240) * window.innerHeight;

                        // Move the visual cursor
                        espCursor.style.left = screenX + 'px';
                        espCursor.style.top = screenY + 'px';

                        // Dwell-Time Interaction: check element under cursor
                        // temporarily hide cursor so elementFromPoint gets the element behind
                        espCursor.style.display = 'none';
                        const hoveredElement = document.elementFromPoint(screenX, screenY);
                        espCursor.style.display = 'block';

                        // Find the closest A-Frame entity that is a menu-option (or any clickable)
                        // We need to traverse shadow DOM? A-Frame elements are in light DOM.
                        let targetEl = hoveredElement;
                        while (targetEl && !targetEl.classList?.contains('menu-option') && targetEl !== document.body) {
                            targetEl = targetEl.parentElement;
                        }

                        if (targetEl && targetEl.classList.contains('menu-option')) {
                            espCursor.classList.add('hovering');
                            // Simulate dwell: we can either click after a delay or trigger immediately.
                            // For simplicity and responsiveness, we click immediately (you can later add delay)
                            // But your thesis uses dwell‚Äëtime; we can add a timer. However for demo, we click.
                            // To mimic dwell, we could start a timer. Let's implement a basic 1s dwell.
                            if (!targetEl._dwellTimer) {
                                targetEl._dwellTimer = setTimeout(() => {
                                    const projectId = targetEl.getAttribute('data-project');
                                    if (projectId) {
                                        launchProject(projectId);
                                    }
                                    targetEl._dwellTimer = null;
                                }, 800); // 0.8 sec dwell
                            }
                        } else {
                            espCursor.classList.remove('hovering');
                            // clear any pending timers on all options (simple approach: clear all)
                            document.querySelectorAll('.menu-option').forEach(opt => {
                                if (opt._dwellTimer) {
                                    clearTimeout(opt._dwellTimer);
                                    opt._dwellTimer = null;
                                }
                            });
                        }
                    } catch (e) {
                        console.warn("Error parsing ESP message", e);
                    }
                };

                socket.onerror = (error) => console.log("WebSocket Error: ", error);
                socket.onclose = () => console.log("ESP socket closed");
            } catch (e) {
                console.warn("Failed to connect ESP, using fallback mouse");
            }
        }

        // ========== ORIGINAL HUB FUNCTIONS ==========
        document.addEventListener('DOMContentLoaded', function() {
            const loadingScreen = document.getElementById('loading-screen');
            const instructions = document.getElementById('instructions');
            
            const scene = document.querySelector('a-scene');
            scene.addEventListener('loaded', function() {
                setTimeout(() => {
                    loadingScreen.style.opacity = '0';
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                        instructions.style.display = 'block';
                    }, 500);
                }, 1000);
            });
            
            setupMenuInteractions();
            setupKeyboardShortcuts();

            // Initialize ESP32 cursor AFTER page fully loads
            setTimeout(() => {
                initESP32Cursor();
            }, 2000); // small delay to ensure A-Frame is stable
        });

        function setupMenuInteractions() {
            const menuOptions = document.querySelectorAll('.menu-option');
            
            menuOptions.forEach(option => {
                // Click event (for mouse/touch)
                option.addEventListener('click', function(ev) {
                    // prevent if triggered by cursor dwell? but we want it.
                    const projectId = this.getAttribute('data-project');
                    launchProject(projectId);
                });
                
                // Mouse enter/leave for visual feedback
                option.addEventListener('mouseenter', function() {
                    const color = this.getAttribute('data-color');
                    const box = this.querySelector('a-box');
                    if (box) {
                        box.setAttribute('color', '#FFFFFF');
                        box.setAttribute('scale', '1.2 1.2 1.2');
                    }
                });
                
                option.addEventListener('mouseleave', function() {
                    const color = this.getAttribute('data-color');
                    const box = this.querySelector('a-box');
                    if (box) {
                        box.setAttribute('color', color);
                        box.setAttribute('scale', '1 1 1');
                    }
                });
            });
            
            // A-Frame cursor fusion (original) - also triggers launch
            const cursor = document.querySelector('a-cursor');
            if (cursor) {
                cursor.addEventListener('fusing', function(evt) {
                    const intersectedEl = evt.detail.intersectedEl;
                    // traversing up to find .menu-option
                    let el = intersectedEl;
                    while (el && !el.classList?.contains('menu-option') && el !== document.documentElement) {
                        el = el.parentElement;
                    }
                    if (el && el.classList.contains('menu-option')) {
                        const projectId = el.getAttribute('data-project');
                        launchProject(projectId);
                    }
                });
            }
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                if (e.key === '1') launchProject('battle-of-quinga');
                if (e.key === '2') launchProject('bulacan-museum');
                if (e.key === '3') launchProject('del-pilar-shrine');
                if (e.key === '4') launchProject('barasoain-museum');
                if (e.key === '5') launchProject('casa-real-shrine');
                
                if (e.key === ' ') {
                    alert('Available tours: 1-5 keys, gaze, or ESP32 cursor hover');
                }
                
                if (e.key === 'f' || e.key === 'F') {
                    toggleFullscreen();
                }
            });
        }

        function launchProject(projectId) {
            const project = projects[projectId];
            if (!project) {
                console.error('Project not found:', projectId);
                return;
            }
            
            // clear any pending dwell timers
            document.querySelectorAll('.menu-option').forEach(opt => {
                if (opt._dwellTimer) {
                    clearTimeout(opt._dwellTimer);
                    opt._dwellTimer = null;
                }
            });

            // Show loading
            const loadingScreen = document.getElementById('loading-screen');
            loadingScreen.style.display = 'flex';
            loadingScreen.style.opacity = '1';
            loadingScreen.innerHTML = `
                <div class="spinner" style="border-top-color: ${project.color}"></div>
                <h2>Loading ${project.name}</h2>
                <p>Entering virtual tour...</p>
            `;
            
            // Navigate after short delay
            setTimeout(() => {
                window.location.href = project.path;
            }, 1500);
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log('Fullscreen error:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // Clean up dwell timers if cursor leaves window
        window.addEventListener('mouseleave', () => {
            document.querySelectorAll('.menu-option').forEach(opt => {
                if (opt._dwellTimer) {
                    clearTimeout(opt._dwellTimer);
                    opt._dwellTimer = null;
                }
            });
        });

        // Also handle when ESP cursor leaves menu
        // But we already handle in onmessage

        console.log('VR Hub with ESP32-CAM integration ready');
    </script>
</body>
</html>