<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VR Heritage Â· Cardboard Fisheye</title>
    
    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    
    <!-- THREE.js StereoEffect for fisheye -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/effects/StereoEffect.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { overflow: hidden; background: #000; }
        
        #esp-cursor {
            position: fixed;
            width: 40px; height: 40px;
            background: rgba(255, 107, 107, 0.7);
            border: 4px solid #FF6B6B;
            border-radius: 50%;
            box-shadow: 0 0 30px #FF6B6B;
            pointer-events: none;
            z-index: 99999;
            transform: translate(-50%, -50%);
            display: none;
            transition: all 0.1s;
        }
        
        #esp-cursor::before {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            width: 8px; height: 8px;
            background: white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        
        #esp-cursor.hovering {
            width: 60px; height: 60px;
            background: rgba(255, 215, 0, 0.7);
            border-color: #FFD700;
            box-shadow: 0 0 40px #FFD700;
        }
        
        #cardboard-toggle {
            position: fixed;
            bottom: 100px; right: 20px;
            width: 70px; height: 70px;
            border-radius: 35px;
            background: #4ECDC4;
            border: 3px solid white;
            box-shadow: 0 0 30px #4ECDC4;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 10px;
            cursor: pointer;
        }
        
        #cardboard-toggle.active {
            background: #FF6B6B;
        }
        
        #status {
            position: fixed;
            top: 20px; right: 20px;
            background: rgba(0,0,0,0.8);
            color: #4ECDC4;
            padding: 8px 16px;
            border-radius: 20px;
            z-index: 1000;
        }
        
        #instructions {
            position: fixed;
            bottom: 30px; left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            z-index: 100;
            border-bottom: 3px solid #FF6B6B;
            white-space: nowrap;
        }
        
        #selection-feedback {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: #4ECDC4;
            color: white;
            padding: 20px 40px;
            border-radius: 50px;
            font-size: 24px;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            border: 3px solid white;
        }
        
        #selection-feedback.show { opacity: 1; }
        
        /* Fisheye canvas styling */
        .stereo-mode canvas {
            width: 50% !important;
            height: 100% !important;
            position: absolute !important;
            top: 0 !important;
            filter: distort(0.5, 0.5); /* Fisheye effect */
        }
        
        .stereo-mode canvas:first-child {
            left: 0 !important;
        }
        
        .stereo-mode canvas:last-child {
            right: 0 !important;
        }
    </style>
</head>
<body>
    <div id="status">ESP32: <span id="esp-status">â—‹</span></div>
    <div id="cardboard-toggle" onclick="toggleCardboard()">
        <span style="font-size: 24px;">ðŸ¥½</span>
        <span>FISHEYE</span>
    </div>
    <div id="instructions">ðŸ‘† Move finger Â· Hover 1s to select</div>
    <div id="selection-feedback"></div>
    <div id="esp-cursor"></div>

    <!-- A-Frame Scene -->
    <a-scene id="scene" embedded background="color: #0a1929" vr-mode-ui="enabled: false">
        
        <!-- Camera -->
        <a-entity camera look-controls position="0 1.6 0" id="camera"></a-entity>
        
        <!-- Title -->
        <a-text value="HISTORICAL SITES OF BULACAN" 
               position="0 2.5 -4" 
               color="#FF6B6B" 
               align="center"
               width="6"></a-text>
        
        <!-- Menu Items -->
        <a-entity position="0 1 -3">
            <!-- 1 -->
            <a-entity class="menu-item" 
                     position="-2 0.5 0" 
                     data-name="Battle of Quinga">
                <a-box width="0.8" height="0.8" depth="0.2" color="#FF6B6B"></a-box>
                <a-text value="âš”ï¸" position="0 0.2 0.2" color="white" align="center"></a-text>
                <a-text value="1" position="0 -0.3 0.2" color="white" align="center"></a-text>
            </a-entity>
            
            <!-- 2 -->
            <a-entity class="menu-item" 
                     position="-1 0.5 0" 
                     data-name="Hiyas ng Bulacan">
                <a-box width="0.8" height="0.8" depth="0.2" color="#4ECDC4"></a-box>
                <a-text value="ðŸ›ï¸" position="0 0.2 0.2" color="white" align="center"></a-text>
                <a-text value="2" position="0 -0.3 0.2" color="white" align="center"></a-text>
            </a-entity>
            
            <!-- 3 -->
            <a-entity class="menu-item" 
                     position="0 0.5 0" 
                     data-name="Del Pilar Shrine">
                <a-box width="0.8" height="0.8" depth="0.2" color="#FFD700"></a-box>
                <a-text value="ðŸ—½" position="0 0.2 0.2" color="white" align="center"></a-text>
                <a-text value="3" position="0 -0.3 0.2" color="white" align="center"></a-text>
            </a-entity>
            
            <!-- 4 -->
            <a-entity class="menu-item" 
                     position="1 0.5 0" 
                     data-name="Barasoain Museum">
                <a-box width="0.8" height="0.8" depth="0.2" color="#FF8E53"></a-box>
                <a-text value="â›ª" position="0 0.2 0.2" color="white" align="center"></a-text>
                <a-text value="4" position="0 -0.3 0.2" color="white" align="center"></a-text>
            </a-entity>
            
            <!-- 5 -->
            <a-entity class="menu-item" 
                     position="2 0.5 0" 
                     data-name="Casa Real">
                <a-box width="0.8" height="0.8" depth="0.2" color="#9B59B6"></a-box>
                <a-text value="ðŸ°" position="0 0.2 0.2" color="white" align="center"></a-text>
                <a-text value="5" position="0 -0.3 0.2" color="white" align="center"></a-text>
            </a-entity>
        </a-entity>
        
        <!-- Floor -->
        <a-grid position="0 -0.5 -3" width="8" height="8" color="#4ECDC4" opacity="0.3"></a-grid>
        
        <!-- Lights -->
        <a-light type="ambient" intensity="1.2"></a-light>
        <a-light type="directional" position="2 4 3"></a-light>
    </a-scene>

    <script>
        // ========== ESP32 CONNECTION ==========
        const ESP32_IP = "192.168.1.10";
        let socket;
        let espConnected = false;
        let hoverTimer;
        let currentTarget = null;
        
        const cursor = document.getElementById('esp-cursor');
        const espStatus = document.getElementById('esp-status');
        
        function connectESP32() {
            try {
                socket = new WebSocket("ws://" + ESP32_IP + ":81");
                
                socket.onopen = () => {
                    console.log("ESP32 Connected");
                    cursor.style.display = 'block';
                    espConnected = true;
                    espStatus.innerHTML = 'â—';
                    espStatus.style.color = '#4ECDC4';
                };
                
                socket.onmessage = (event) => {
                    try {
                        const [x, y] = event.data.split(',').map(Number);
                        if (!isNaN(x) && !isNaN(y)) {
                            const screenX = (x / 320) * window.innerWidth;
                            const screenY = (y / 240) * window.innerHeight;
                            
                            cursor.style.left = screenX + 'px';
                            cursor.style.top = screenY + 'px';
                            
                            checkHover(screenX, screenY);
                        }
                    } catch(e) {}
                };
                
                socket.onclose = () => {
                    espStatus.innerHTML = 'â—‹';
                    espStatus.style.color = '#FF6B6B';
                    espConnected = false;
                    setTimeout(connectESP32, 3000);
                };
            } catch(e) {
                setTimeout(connectESP32, 3000);
            }
        }
        
        function checkHover(x, y) {
            cursor.style.display = 'none';
            const elem = document.elementFromPoint(x, y);
            cursor.style.display = 'block';
            
            let target = elem;
            while (target && !target.classList?.contains('menu-item')) {
                target = target.parentElement;
            }
            
            if (!target) {
                cursor.classList.remove('hovering');
                if (hoverTimer) clearTimeout(hoverTimer);
                currentTarget = null;
                return;
            }
            
            cursor.classList.add('hovering');
            
            if (currentTarget !== target) {
                if (hoverTimer) clearTimeout(hoverTimer);
                currentTarget = target;
                
                hoverTimer = setTimeout(() => {
                    const name = target.getAttribute('data-name');
                    if (name) {
                        showFeedback(name);
                    }
                    hoverTimer = null;
                    currentTarget = null;
                }, 1000);
            }
        }
        
        function showFeedback(name) {
            const feedback = document.getElementById('selection-feedback');
            feedback.textContent = "ðŸ“ " + name;
            feedback.classList.add('show');
            setTimeout(() => feedback.classList.remove('show'), 1500);
        }
        
        // ========== CARDBOARD FISHEYE MODE ==========
        let stereoActive = false;
        let stereoEffect;
        let renderer;
        let scene;
        let camera;
        
        function initStereo() {
            // Get THREE.js objects from A-Frame
            const aframeScene = document.querySelector('a-scene');
            if (!aframeScene) return;
            
            aframeScene.addEventListener('loaded', () => {
                scene = aframeScene.object3D;
                camera = aframeScene.camera;
                renderer = aframeScene.renderer;
                
                if (renderer && camera) {
                    stereoEffect = new THREE.StereoEffect(renderer);
                    stereoEffect.setSize(window.innerWidth, window.innerHeight);
                    
                    // Override render loop for fisheye
                    const originalRender = aframeScene.render;
                    aframeScene.render = function() {
                        if (stereoActive && stereoEffect) {
                            stereoEffect.render(scene, camera);
                        } else {
                            originalRender.call(aframeScene);
                        }
                    };
                }
            });
        }
        
        function toggleCardboard() {
            const btn = document.getElementById('cardboard-toggle');
            stereoActive = !stereoActive;
            
            if (stereoActive) {
                btn.classList.add('active');
                btn.innerHTML = '<span style="font-size:24px;">â—€â–¶</span><span>EXIT</span>';
                document.body.classList.add('stereo-mode');
                
                // Force resize for stereo
                window.dispatchEvent(new Event('resize'));
            } else {
                btn.classList.remove('active');
                btn.innerHTML = '<span style="font-size:24px;">ðŸ¥½</span><span>FISHEYE</span>';
                document.body.classList.remove('stereo-mode');
                
                window.dispatchEvent(new Event('resize'));
            }
        }
        
        // ========== INIT ==========
        window.onload = () => {
            setTimeout(connectESP32, 2000);
            initStereo();
            
            // Hide loading (simple)
            setTimeout(() => {
                const loading = document.createElement('div');
                // Add if you want loading screen
            }, 2000);
        };
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            const num = parseInt(e.key);
            const names = [
                'Battle of Quinga',
                'Hiyas ng Bulacan',
                'Del Pilar Shrine',
                'Barasoain Museum',
                'Casa Real'
            ];
            if (num >= 1 && num <= 5) {
                showFeedback(names[num-1]);
            }
        });
    </script>
</body>
</html>